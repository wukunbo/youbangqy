<include file="Public/includeHeader" />

﻿<div class="row">
	<div class="col-lg-12">
		<h3 class="page-header">创建活动</h3>
		
	</div>
</div>


<div class="panel panel-default">
	<form action="userweb.php?c=activity&a=add_action"  enctype="multipart/form-data"  method="post" name="form1">
		<input type="text" style="display:none;" name="post[id]"  class="form-control" value="{$data[detail]['id']}">
		<div class="panel-body">

			<div class="form-group">
				<label for="text-input" class="col-md-2 control-label">部门:</label>
				<div class="col-md-4 input-group ">
					<select name="post[partment]" id="partment" class="form-control">
						<volist name="partment_list" id="list">
							<option value="{$list[id]}" <if condition="$list.id eq $data[detail]['partment']">selected</if>>{$list[title]}</option>
						</volist>
					</select>

				</div>
			</div>

			<div class="form-group">
				<label for="text-input" class="col-md-2 control-label">活动类型:</label>
				<div class="col-md-4 input-group ">
					<select name="post[category]" id="category" class="form-control">
						<volist name="category_list" id="list">
							
							<option value="{$list.cate_id}" <if condition="$list.cate_id eq $data[detail]['category']">selected</if>>{$list.cat_name}</option>
						</volist>
					</select>

				</div>
			</div>

			<div class="form-group">
				<label for="text-input" class="col-md-2 control-label">活动名称:</label>
				<div class="col-md-4 input-group ">
					<input type="text" name="post[title]"  class="form-control" value="{$data[detail]['title']}">
				</div>
			</div>

			<div class="form-group">
				<label for="text-input" class="col-md-2 control-label">活动简介:</label>
				<div class="col-md-4 input-group ">
					<textarea id="intro" onkeyup="intro_content(event);" name="post[intro]" style="width:500px;height:200px;">{$data[detail]['intro']}</textarea>
				</div>
			</div>

			<script src="tool/My97DatePicker/WdatePicker.js"></script>

			<div class="form-group">
				<label for="text-input" class="col-md-2 control-label">报名开始:</label>
				<div class="col-md-4 input-group ">
					<input type="text" name="post[time_start]" value="<if condition="$data[detail][time_start] neq ''">{$data[detail][time_start_text]}</if>" class="form-control" onClick="WdatePicker({dateFmt:'yyyy-MM-dd H:m:s'})">
				</div>
			</div>

			

			<div class="form-group">
				<label for="text-input" class="col-md-2 control-label">报名截止:</label>
				<div class="col-md-8 input-group ">
					<input style="width: 250px" type="text" name="post[time_apply]" value="<if condition="$data[detail][time_apply] neq ''">{$data[detail][time_apply_text]}</if>" class="form-control" onClick="WdatePicker({dateFmt:'yyyy-MM-dd H:m:s'})">
					&nbsp;&nbsp;<input id="apply_remind" onclick="show_apply()" type="checkbox" name="post[apply_remind]" class="input_checkbox" style="vertical-align: sub;" <if condition="$data[detail]['apply_remind'] eq 'on'"> checked="true/" </if>>是否提醒
					&nbsp;
					<span id="show_apply" <if condition="$data[detail]['apply_remind'] neq 'on' ">style="display: none;"</if>>
					报名截止前
					<select style="width: 100px" name="post[end_publish]" id="end_publish">
						<option value="15" <if condition="$data[detail]['end_publish'] eq 15 ">selected</if>>15分钟</option>
						<option value="30" <if condition="$data[detail]['end_publish'] eq 30 ">selected</if>>30分钟</option>
						<option value="60" <if condition="$data[detail]['end_publish'] eq 60 ">selected</if>>1小时</option>
						<option value="120" <if condition="$data[detail]['end_publish'] eq 120 ">selected</if>>2小时</option>
						<option value="180" <if condition="$data[detail]['end_publish'] eq 180 ">selected</if>>3小时</option>
						<option value="240" <if condition="$data[detail]['end_publish'] eq 240 ">selected</if>>4小时</option>
					</select>
					</span>
				</div>
			</div>

			<!-- <div class="form-group">
				<label for="text-input" class="col-md-2 control-label">报名截止前几小时推送:</label>
				<div class="col-md-4 input-group ">
					<input type="number" name="post[end_publish]"  class="form-control" value="{$data[detail]['end_publish']}">
				</div>
			</div> -->


			<div class="form-group">
				<label for="text-input" class="col-md-2 control-label">签到开始:</label>
				<div class="col-md-8 input-group ">
					<input style="width: 250px" type="text" name="post[signstart_time]" value="<if condition="$data[detail][signstart_time] neq 0">{$data[detail][signstart_time]|date="Y-m-d H:i:s",###}</if>" class="form-control" onClick="WdatePicker({dateFmt:'yyyy-MM-dd H:m:s'})">
					&nbsp;&nbsp;<input id="sign_remind" onclick="show_sign()" type="checkbox" name="post[sign_remind]" class="input_checkbox" style="vertical-align: sub;" <if condition="$data[detail]['sign_remind'] eq 'on'"> checked="true/" </if>>是否提醒
					&nbsp;
					<span id="show_sign" <if condition="$data[detail]['sign_remind'] neq 'on' ">style="display: none;"</if>>
					签到开始前
					<select style="width: 100px" name="post[sign_publish]" id="sign_publish">
						<option value="15" <if condition="$data[detail]['sign_publish'] eq 15 ">selected</if>>15分钟</option>
						<option value="30" <if condition="$data[detail]['sign_publish'] eq 30 ">selected</if>>30分钟</option>
						<option value="60" <if condition="$data[detail]['sign_publish'] eq 60 ">selected</if>>1小时</option>
						<option value="120" <if condition="$data[detail]['sign_publish'] eq 120 ">selected</if>>2小时</option>
						<option value="180" <if condition="$data[detail]['sign_publish'] eq 180 ">selected</if>>3小时</option>
						<option value="240" <if condition="$data[detail]['sign_publish'] eq 240 ">selected</if>>4小时</option>
					</select>
					</span>

				</div>
			</div>

			<div class="form-group">
				<label for="text-input" class="col-md-2 control-label">签到结束:</label>
				<div class="col-md-4 input-group ">
					<input type="text" name="post[signend_time]" value="<if condition="$data[detail][signend_time] neq 0">{$data[detail][signend_time]|date="Y-m-d H:i:s",###}</if>" class="form-control" onClick="WdatePicker({dateFmt:'yyyy-MM-dd H:m:s'})">
				</div>
			</div>



			<!-- <div class="form-group">
				<label for="text-input" class="col-md-2 control-label">签到截止时间:</label>
				<div class="col-md-4 input-group ">
					<input type="text" name="post[signend_time]" value="<if condition="$data[detail][signend_time] neq ''">{$data[detail][signend_time]|date="H:i:s",###}</if>" class="form-control" onClick="WdatePicker({dateFmt:'H:mm:ss',minDate: '0:00:00', maxDate: '24:00:00'})">
				</div>
			</div> -->

			<div class="form-group">
				<label for="text-input" class="col-md-2 control-label">活动开始:</label>
				<div class="col-md-8 input-group ">
					<input style="width: 250px" type="text" name="post[start_time]" value="<if condition="$data[detail][start_time] neq 0">{$data[detail][start_time]|date="Y-m-d H:i:s",###}</if>" class="form-control" onClick="WdatePicker({dateFmt:'yyyy-MM-dd H:m:s'})">
					&nbsp;&nbsp;<input id="start_remind" onclick="show_start()" type="checkbox" name="post[start_remind]" class="input_checkbox" style="vertical-align: sub;" <if condition="$data[detail]['start_remind'] eq 'on'"> checked="true/" </if>>是否提醒
					&nbsp;
					<span id="show_start" <if condition="$data[detail]['start_remind'] neq 'on' ">style="display: none;"</if>>
					活动开始前
					<select style="width: 100px" name="post[start_publish]" id="start_publish">
						<option value="15" <if condition="$data[detail]['start_publish'] eq 15 ">selected</if>>15分钟</option>
						<option value="30" <if condition="$data[detail]['start_publish'] eq 30 ">selected</if>>30分钟</option>
						<option value="60" <if condition="$data[detail]['start_publish'] eq 60 ">selected</if>>1小时</option>
						<option value="120" <if condition="$data[detail]['start_publish'] eq 120 ">selected</if>>2小时</option>
						<option value="180" <if condition="$data[detail]['start_publish'] eq 180 ">selected</if>>3小时</option>
						<option value="240" <if condition="$data[detail]['start_publish'] eq 240 ">selected</if>>4小时</option>
					</select>
					</span>


				</div>
			</div>

			<!-- <div class="form-group">
				<label for="text-input" class="col-md-2 control-label">活动开始前几小时推送:</label>
				<div class="col-md-4 input-group ">
					<input type="number" name="post[start_publish]"  class="form-control" value="{$data[detail]['start_publish']}">
				</div>
			</div> -->

			<div class="form-group">
				<label for="text-input" class="col-md-2 control-label">活动结束:</label>
				<div class="col-md-4 input-group ">
					<input type="text" name="post[end_time]" value="<if condition="$data[detail][end_time] neq 0">{$data[detail][end_time]|date="Y-m-d H:i:s",###}</if>" class="form-control" onClick="WdatePicker({dateFmt:'yyyy-MM-dd H:m:s'})">
				</div>
			</div>

			<div class="form-group">
				<label for="text-input" class="col-md-2 control-label">活动背景图:</label>
				<div class="col-md-4 input-group ">
					<img alt="Sample Image" src="{$data[detail]['img_thumb']}" style="<if condition="$data[detail]['img_thumb'] eq ''">display:none;
					</if>
					width:100px" id="UploadImg_src" class="img-thumbnail">
 
					<input type="hidden" name="post[img_thumb]" id="img_thumb_hidden" value="{$data[detail]['img_thumb']}">
					<input type="hidden" name="post[img_orgin]" id="img_orogin_hidden" value="{$data[detail]['img_orgin']}">
					<i class="fa fa-plus"></i><a type="button" onclick="show_content('userweb.php?c=Config&a=material_lists&ajax=1&return_fn=material_select')" >添加图片 </a>

					<input type="checkbox" name="post[show_content]" class="input_checkbox" style="vertical-align: sub;" <if condition="$data[detail]['show_content'] eq 'on'"> checked="true/" </if>>
					图片显示到详情
					<!--打开图册-->
					<script src="{$config["static"]}/public/js/material_lists_ajax.js">
						</script>
					<script src="tool/ajaxFileUpload/jquery.ajaxFileUpload.js" type="text/javascript"></script>
					<script>
						//选择图片之后
						function material_select(img_thumb,img_orogin){
							//alert(img_thumb+img_orogin);
							$("#UploadImg_src").show();
							$("#UploadImg_src").attr("src",img_thumb);
							$("#img_thumb_hidden").val(img_thumb);
							$("#img_orogin_hidden").val(img_orogin);
							show_content_close();
						}
					</script>
				</div>
			</div>

			<div class="form-group">
				<label for="text-input" class="col-md-2 control-label">报名人数上限:</label>
				<div class="col-md-4 input-group ">
					<input type="text" name="post[person_count]"  class="form-control" value="{$data[detail]['person_count']}">
				</div>
			</div>

			<div class="form-group">
				<label for="text-input" class="col-md-2 control-label">活动地区:</label>
				<div class="col-md-4 input-group ">
				<script>
				select_province='{$data[detail][province]}';
				select_city='{$data[detail][city]}';
				select_area='{$data[detail][area]}';
				select_district='{$data[detail][district]}';
				select_estate='{$data[detail][estate]}';
				</script>
				<include file="Public/region" />
				</div>
			</div>
			<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=NDdLGGGIk4B3WvOZYx0NpRu3"></script>
			<div class="form-group">
				<label for="text-input" class="col-md-2 control-label">详细地址:</label>		
				<div class="col-md-4 input-group ">
					<input onBlur="searchByStationName();" id="searchAddress" type="text" name="post[address]" value="{$data[detail]['address']}" class="form-control">
					<input id="addresslng" name="post[lng]" type="hidden" value="{$data[detail]['lng']}">
					<input id="addresslat" name="post[lat]" type="hidden" value="{$data[detail]['lat']}">

					<input id="baidulng" name="post[baidu_lng]" type="hidden" value="{$data[detail]['baidu_lng']}">
					<input id="baidulat" name="post[baidu_lat]" type="hidden" value="{$data[detail]['baidu_lat']}">

				<!-- 	<input type="button" value="查询" onclick="searchByStationName();"/> -->
					<div id="container" style="margin-top:10px;display:block; float:left; width:600px;height: 400px">
						
					</div>
				</div>
			</div>


			<div class="form-group">
				<label for="text-input" class="col-md-2 control-label">活动详情:</label>
				<div class="col-md-4 input-group ">
					<div style="display:block; float:left; width:800px;height: 400px">
						<link rel="stylesheet" href="tool/kindeditor-4.1.10//themes/default/default.css" />
						<link rel="stylesheet" href="tool/kindeditor-4.1.10/plugins/code/prettify.css" />
						<script charset="utf-8" src="tool/kindeditor-4.1.10/kindeditor.js"></script>
						<script charset="utf-8" src="tool/kindeditor-4.1.10/lang/zh_CN.js"></script>
						<script charset="utf-8" src="tool/kindeditor-4.1.10/plugins/code/prettify.js"></script>
						<script>
			 
										KindEditor.ready(function(K) {
											var editor1 = K.create('textarea[id="editor_id"]', {
												cssPath : 'tool/kindeditor-4.1.10/plugins/code/prettify.css',
												uploadJson : 'tool/kindeditor-4.1.10/php/upload_json.php',
												fileManagerJson : 'tool/kindeditor-4.1.10/php/file_manager_json.php',
												allowFileManager : true,
											    filterMode : true,
												afterCreate : function() {
													 var self = this;
													K.ctrl(document, 13, function() {
														self.sync();
														K('form[name=add_goods]')[0].submit();
													});
													K.ctrl(self.edit.doc, 13, function() {
														self.sync();
														K('form[name=add_goods]')[0].submit();
														 
													});
												}
											});
											prettyPrint();
										});
	 
								</script>
						<textarea id="editor_id" name="post[content]" style="width:600px;height:400px;">{$data['detail']['content']}</textarea>
					</div>
				</div>
			</div>


		</div>
		<div class="panel-footer">
			<button id="activity_btn"class="btn btn-sm btn-success" type="submit" onclick1="save_vote()"><i class="fa fa-dot-circle-o"></i> 保存</button>
			<button class="btn btn-sm btn-danger" type="reset"><i class="fa fa-ban"></i> 重置</button>
		</div>
	</form>
</div>

<include file="Public/includeFooter" />
<script charset="utf-8" src="http://map.qq.com/api/js?v=2.exp&libraries=convertor"></script>

<script type="text/javascript">
var is_onclick=false;
$(function(){
	$("#activity_btn").click(function(){
		is_onclick=true;
	});
})
window.onbeforeunload = function() {
	if(is_onclick){
		return;
	}else{
		return "您的内容还没有保存，您确定离开吗？";
	}
	 
}

function show_apply(){
	checked=$("#apply_remind").prop("checked"); 
    if(checked==true){
    	$("#show_apply").show();
    }else{
    	$("#show_apply").hide();
    }
}

function show_sign(){
	checked=$("#sign_remind").prop("checked"); 
    if(checked==true){
    	$("#show_sign").show();
    }else{
    	$("#show_sign").hide();
    }
}

function show_start(){
	checked=$("#start_remind").prop("checked"); 
    if(checked==true){
    	$("#show_start").show();
    }else{
    	$("#show_start").hide();
    }
}

</script>

<script type="text/javascript"> 
	var map = new BMap.Map("container");          // 创建地图实例 
	var point = new BMap.Point({$mylng},{$mylat});  // 创建点坐标  
	map.enableScrollWheelZoom();    //启用滚轮放大缩小，默认禁用
    // map.enableContinuousZoom();    //启用地图惯性拖拽，默认禁用
    map.addControl(new BMap.NavigationControl());  //添加默认缩放平移控件
    map.addControl(new BMap.OverviewMapControl()); //添加默认缩略地图控件
	map.centerAndZoom(point, 12);                 // 初始化地图，设置中心点坐标和地图级别
	var marker = new BMap.Marker(point);  // 创建标注
	map.addOverlay(marker);              // 将标注添加到地图中
	var label = new BMap.Label('{$data[detail][address]}',{offset:new BMap.Size(20,-10)});
	marker.setLabel(label);
	// map.enableClick(true);
	
	map.addEventListener("click",function(e){
		map.clearOverlays(); 
		var point1 = new BMap.Point(e.point.lng,e.point.lat);
		var marker1 = new BMap.Marker(point1);
		map.addOverlay(marker1);              // 将标注添加到地图中

		$("#baidulng").val(e.point.lng);
		$("#baidulat").val(e.point.lat);

		qq.maps.convertor.translate(new qq.maps.LatLng(point.lat,point.lng), 3, function(res) {
    		latlng = res[0];
    		var str=latlng+",";
    		var arr=str.split(',');

			var lat1=arr[0];
			var lng1=arr[1];

			$("#addresslng").val(lng1);
			$("#addresslat").val(lat1);
		});

	});

	var localSearch = new BMap.LocalSearch(map);
    localSearch.enableAutoViewport(); //允许自动调节窗体大小
    var myGeo = new BMap.Geocoder();

	function searchByStationName() {
	    map.clearOverlays();//清空原来的标注
	    var provice=$("#province").find("option:selected").text();
	    var city=$("#city").find("option:selected").text();
	    var area=$("#area").find("option:selected").text();

	    var keyword =provice+city+area+document.getElementById("searchAddress").value;

	    
		// 将地址解析结果显示在地图上,并调整地图视野
		myGeo.getPoint(keyword, function(point){
			if (point) {
				// alert(point.lng+"-"+point.lat);
				//
				//
				$("#baidulng").val(point.lng);
				$("#baidulat").val(point.lat);
				
				//将百度坐标转换腾讯坐标
				qq.maps.convertor.translate(new qq.maps.LatLng(point.lat,point.lng), 3, function(res) {
	        		latlng = res[0];
	        		var str=latlng+",";
	        		var arr=str.split(',');

					var lat1=arr[0];
					var lng1=arr[1];

					$("#addresslng").val(lng1);
					$("#addresslat").val(lat1);
				});

				map.centerAndZoom(point, 12);

				var marker = new BMap.Marker(point);  // 创建标注
				map.addOverlay(marker);              // 将标注添加到地图中
				var label = new BMap.Label(keyword,{offset:new BMap.Size(20,-10)});
				marker.setLabel(label);
			}else{
				alert("您选择地址没有解析到结果!");
			}
		});
	}

	var GetLength = function (str) {
        ///<summary>获得字符串实际长度，中文2，英文1</summary>
        ///<param name="str">要获得长度的字符串</param>
        var realLength = 0, len = str.length, charCode = -1;
        for (var i = 0; i < len; i++) {
            charCode = str.charCodeAt(i);
            if (charCode >= 0 && charCode <= 128) realLength += 1;
            else realLength += 2;
        }
        return realLength;
    };

    //js截取字符串，中英文都能用  
    //如果给定的字符串大于指定长度，截取指定长度返回，否者返回源字符串。  
    //字符串，长度  

    /** 
     * js截取字符串，中英文都能用 
     * @param str：需要截取的字符串 
     * @param len: 需要截取的长度 
     */
    function cutstr(str, len) {
        var str_length = 0;
        var str_len = 0;
        str_cut = new String();
        str_len = str.length;
        for (var i = 0; i < str_len; i++) {
            a = str.charAt(i);
            str_length++;
            if (escape(a).length > 4) {
                //中文字符的长度经编码之后大于4  
                str_length++;
            }
            str_cut = str_cut.concat(a);
            if (str_length >= len) {
                str_cut = str_cut.concat("...");
                return str_cut;
            }
        }
        //如果给定字符串小于指定长度，则返回源字符串；  
        if (str_length < len) {
            return str;
        }
    }

    function intro_content(e){
    	var et=e||window.event;
    	var keycode=et.charCode||et.keyCode;   
	    if(keycode==13)
	    {
	    	alert("不可换行哦！！，请撤销换行符");
	        if(window.event){
	        	window.event.returnValue = false;
	        }else{
	        	e.preventDefault();//for firefox
	        }
	           
	    }
    	if (GetLength($("#intro").val()) > 240) {
    		$("#intro").val(cutstr($("#intro").val(), 240));
     		return; 
    	}

    }

</script>  